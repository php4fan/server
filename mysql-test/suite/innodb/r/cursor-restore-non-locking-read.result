SET @saved_frequency = @@GLOBAL.innodb_purge_rseg_truncate_frequency;
SET GLOBAL innodb_purge_rseg_truncate_frequency=1;
CREATE TABLE t1 (pk int PRIMARY KEY, c int UNIQUE) ENGINE=InnoDB;
INSERT INTO t1 VALUES (10,10),(20,20),(30,30);
connect prevent_purge,localhost,root,,;
start transaction with consistent snapshot;
UPDATE t1 SET c=300 WHERE pk = 30;
connection default;
DELETE FROM t1 WHERE pk = 10;
INSERT INTO t1 VALUES(5,10);
SET DEBUG_SYNC = "row_search_clust_unlatched SIGNAL unlatched WAIT_FOR cont";
SELECT pk FROM t1 FORCE INDEX (c);
connect con1,localhost,root,,;
SET DEBUG_SYNC = "now WAIT_FOR unlatched";
disconnect prevent_purge;
InnoDB		1 transactions not purged
SET DEBUG_SYNC = 'now SIGNAL cont';
disconnect con1;
connection default;
pk
5
20
30
SET DEBUG_SYNC = 'RESET';
DROP TABLE t1;
SET GLOBAL innodb_purge_rseg_truncate_frequency = @saved_frequency;
